name: Deploy to Azure App Service (Blue-Green)

on:
  push:
    branches: [main]
    paths: ['app/**', 'infrastructure/**', '.github/workflows/**']
  # workflow_dispatch:
  #   inputs:
  #     environment:
  #       description: 'Environment to deploy'
  #       required: true
  #       default: 'dev'
  #       type: choice
  #       options:
  #         - dev


env:
  TERRAFORM_VERSION: '1.13.5'

jobs:
  # ============================================================
  # STAGE 1: Build Application
  # ============================================================
  build-app:
    name: Build and Test Application
    uses: ./.github/workflows/_build-app.yml
    with:
      dotnet-version: '9.0.x'

  # ============================================================
  # STAGE 2: Provision Infrastructure in Azure
  # ============================================================
  provision-infra:
    name: 'Stage 2: Provision Infrastructure'
    runs-on: ubuntu-latest
    needs: build-app
    environment: dev
    outputs:
      app_service_name: ${{ steps.terraform-output.outputs.app_service_name }}
      resource_group_name: ${{ steps.terraform-output.outputs.resource_group_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Environment Variables for Terraform
        run: |
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: ./infrastructure/terraform/environments/dev
        run: terraform init

      - name: Terraform Plan
        working-directory: ./infrastructure/terraform/environments/dev
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./infrastructure/terraform/environments/dev     
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: terraform-output
        working-directory: ./infrastructure/terraform/environments/dev
        run: |
          APP_NAME=$(terraform output -raw app_service_name)
          RG_NAME=$(terraform output -raw resource_group_name)
          echo "app_service_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "resource_group_name=$RG_NAME" >> $GITHUB_OUTPUT
          echo "App Service: $APP_NAME"
          echo "Resource Group: $RG_NAME"

      - name: '‚úÖ Stage 2 Complete'
        run: echo "Infrastructure provisioned successfully"

  # # ============================================================
  # # STAGE 3: Deploy to Green Slot
  # # ============================================================
  # deploy-to-green:
  #   name: 'Stage 3: Deploy to Green Slot'
  #   runs-on: ubuntu-latest
  #   needs: provision-infra
  #   environment: 
  #     name: dev-green
  #     url: https://${{ needs.provision-infra.outputs.app_service_name }}-green.azurewebsites.net
    
  #   steps:
  #     - name: Download artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: dotnet-app
  #         path: ./publish

  #     - name: Azure Login
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}

  #     - name: Deploy to Green Slot
  #       uses: azure/webapps-deploy@v2
  #       with:
  #         app-name: ${{ needs.provision-infra.outputs.app_service_name }}
  #         slot-name: 'green'
  #         package: ./publish

  #     - name: Wait for Green Slot to warm up
  #       run: sleep 30

  #     - name: '‚úÖ Stage 3 Complete'
  #       run: |
  #         echo "Application deployed to green slot"
  #         echo "Green URL: https://${{ needs.provision-infra.outputs.app_service_name }}-green.azurewebsites.net"

  # # ============================================================
  # # STAGE 4: Regression Tests on Green
  # # ============================================================
  # regression-tests:
  #   name: 'Stage 4: Regression Tests on Green'
  #   runs-on: ubuntu-latest
  #   needs: 
  #     - provision-infra
  #     - deploy-to-green
    
  #   steps:
  #     - name: Checkout code (for test scripts)
  #       uses: actions/checkout@v4

  #     - name: Set Green Slot URL
  #       id: urls
  #       run: |
  #         GREEN_URL="https://${{ needs.provision-infra.outputs.app_service_name }}-green.azurewebsites.net"
  #         echo "green_url=$GREEN_URL" >> $GITHUB_OUTPUT
  #         echo "Testing Green Slot: $GREEN_URL"

  #     - name: Health Check
  #       run: |
  #         GREEN_URL="${{ steps.urls.outputs.green_url }}"
          
  #         echo "Running health check..."
  #         for i in {1..5}; do
  #           HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $GREEN_URL/health || echo "000")
  #           if [ "$HTTP_CODE" = "200" ]; then
  #             echo "‚úÖ Health check passed (attempt $i)"
  #             break
  #           fi
  #           echo "‚è≥ Health check attempt $i failed (HTTP $HTTP_CODE), retrying..."
  #           sleep 10
  #         done
          
  #         if [ "$HTTP_CODE" != "200" ]; then
  #           echo "‚ùå Health check failed after 5 attempts"
  #           exit 1
  #         fi

  #     - name: API Endpoint Tests
  #       run: |
  #         GREEN_URL="${{ steps.urls.outputs.green_url }}"
          
  #         echo "Testing /api/orders endpoint..."
  #         HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $GREEN_URL/api/orders || echo "000")
  #         if [ "$HTTP_CODE" != "200" ]; then
  #           echo "‚ùå Orders endpoint test failed (HTTP $HTTP_CODE)"
  #           exit 1
  #         fi
  #         echo "‚úÖ Orders endpoint test passed"
          
  #         echo "Testing /api/payments endpoint..."
  #         HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $GREEN_URL/api/payments || echo "000")
  #         if [ "$HTTP_CODE" != "200" ]; then
  #           echo "‚ùå Payments endpoint test failed (HTTP $HTTP_CODE)"
  #           exit 1
  #         fi
  #         echo "‚úÖ Payments endpoint test passed"

  #     - name: Response Time Check
  #       run: |
  #         GREEN_URL="${{ steps.urls.outputs.green_url }}"
          
  #         echo "Checking response time..."
  #         RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' $GREEN_URL/health)
  #         echo "Response time: ${RESPONSE_TIME}s"
          
  #         # Fail if response time > 3 seconds
  #         if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
  #           echo "‚ùå Response time too slow: ${RESPONSE_TIME}s"
  #           exit 1
  #         fi
  #         echo "‚úÖ Response time acceptable"

  #     - name: Smoke Tests Summary
  #       run: |
  #         echo "================================"
  #         echo "üß™ All Regression Tests Passed"
  #         echo "================================"
  #         echo "‚úÖ Health check"
  #         echo "‚úÖ API endpoints"
  #         echo "‚úÖ Response time"
  #         echo "================================"

  #     - name: '‚úÖ Stage 4 Complete'
  #       run: echo "All regression tests passed on green slot"

  # # ============================================================
  # # STAGE 5: Swap Green to Production (Blue)
  # # ============================================================
  # swap-to-blue:
  #   name: 'Stage 5: Swap to Production'
  #   runs-on: ubuntu-latest
  #   needs: 
  #     - provision-infra
  #     - regression-tests
  #   environment:
  #     name: dev-production
  #     url: https://${{ needs.provision-infra.outputs.app_service_name }}.azurewebsites.net
    
  #   steps:
  #     - name: Azure Login
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}

  #     - name: Swap Green to Production
  #       run: |
  #         echo "üîÑ Swapping green slot to production..."
  #         az webapp deployment slot swap \
  #           --resource-group ${{ needs.provision-infra.outputs.resource_group_name }} \
  #           --name ${{ needs.provision-infra.outputs.app_service_name }} \
  #           --slot green \
  #           --target-slot production

  #     - name: Wait for swap to complete
  #       run: sleep 20

  #     - name: Verify Production
  #       run: |
  #         PROD_URL="https://${{ needs.provision-infra.outputs.app_service_name }}.azurewebsites.net"
          
  #         echo "Verifying production deployment..."
  #         HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/health || echo "000")
          
  #         if [ "$HTTP_CODE" != "200" ]; then
  #           echo "‚ùå Production verification failed (HTTP $HTTP_CODE)"
  #           exit 1
  #         fi
          
  #         echo "‚úÖ Production is healthy"
  #         echo "üéâ Application live at: $PROD_URL"

  #     - name: '‚úÖ Stage 5 Complete'
  #       run: echo "Successfully swapped to production"

  # # ============================================================
  # # STAGE 6: Rollback (Only runs if previous stages fail)
  # # ============================================================
  # rollback:
  #   name: 'Stage 6: Rollback'
  #   runs-on: ubuntu-latest
  #   needs: 
  #     - provision-infra
  #     - deploy-to-green
  #     - regression-tests
  #     - swap-to-blue
  #   if: failure()
  #   environment: dev-rollback
    
  #   steps:
  #     - name: Azure Login
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}

  #     - name: Rollback - Swap back to previous version
  #       run: |
  #         echo "‚ö†Ô∏è Deployment or tests failed. Initiating rollback..."
  #         az webapp deployment slot swap \
  #           --resource-group ${{ needs.provision-infra.outputs.resource_group_name }} \
  #           --name ${{ needs.provision-infra.outputs.app_service_name }} \
  #           --slot green \
  #           --target-slot production

  #     - name: Wait for rollback to complete
  #       run: sleep 15

  #     - name: Verify Rollback
  #       run: |
  #         PROD_URL="https://${{ needs.provision-infra.outputs.app_service_name }}.azurewebsites.net"
          
  #         echo "Verifying rollback..."
  #         HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/health || echo "000")
          
  #         if [ "$HTTP_CODE" != "200" ]; then
  #           echo "‚ùå Rollback verification failed"
  #           exit 1
  #         fi
          
  #         echo "‚úÖ Rollback successful - previous version restored"

  #     - name: 'üî¥ Stage 6 Complete (Rollback)'
  #       run: |
  #         echo "================================"
  #         echo "‚ö†Ô∏è  ROLLBACK EXECUTED"
  #         echo "================================"
  #         echo "Previous version has been restored"
  #         echo "Please investigate the deployment failure"

  # # ============================================================
  # # Success Notification
  # # ============================================================
  # notify-success:
  #   name: 'Notify Success'
  #   runs-on: ubuntu-latest
  #   needs: swap-to-blue
  #   if: success()
    
  #   steps:
  #     - name: Deployment Success
  #       run: |
  #         echo "================================"
  #         echo "üéâ DEPLOYMENT SUCCESSFUL"
  #         echo "================================"
  #         echo "All 5 stages completed:"
  #         echo "‚úÖ 1. Build Application"
  #         echo "‚úÖ 2. Provision Infrastructure"
  #         echo "‚úÖ 3. Deploy to Green Slot"
  #         echo "‚úÖ 4. Regression Tests"
  #         echo "‚úÖ 5. Swap to Production"
  #         echo "================================"
