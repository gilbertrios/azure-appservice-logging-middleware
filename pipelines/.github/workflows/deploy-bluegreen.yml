name: Blue/Green Deployment to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: your-app-service-name    # Set your App Service name
  DOTNET_VERSION: '8.0.x'                     # Set your .NET version
  AZURE_WEBAPP_PACKAGE_PATH: './src/Api'      # Path to your web app project
  STAGING_SLOT_NAME: 'staging'                # Name of staging slot for blue/green

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: Build application
        run: dotnet build ${{ env.AZURE_WEBAPP_PACKAGE_PATH }} --configuration Release --no-restore

      - name: Run unit tests
        run: dotnet test ./tests/Middleware.Tests --configuration Release --no-build --verbosity normal

      - name: Publish application
        run: dotnet publish ${{ env.AZURE_WEBAPP_PACKAGE_PATH }} --configuration Release --no-build --output ./publish

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-app
          path: ./publish

  deploy-to-staging:
    name: Deploy to Staging Slot
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging
      url: ${{ steps.deploy-to-slot.outputs.webapp-url }}
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: dotnet-app

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to staging slot
        id: deploy-to-slot
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: ${{ env.STAGING_SLOT_NAME }}
          package: .

      - name: Output staging URL
        run: |
          echo "Deployed to staging slot: ${{ steps.deploy-to-slot.outputs.webapp-url }}"

  smoke-tests:
    name: Run Smoke Tests on Staging
    runs-on: ubuntu-latest
    needs: deploy-to-staging
    
    steps:
      - name: Checkout code (for test scripts)
        uses: actions/checkout@v4

      - name: Wait for staging slot to be ready
        run: sleep 30

      - name: Health check on staging slot
        run: |
          STAGING_URL="https://${{ env.AZURE_WEBAPP_NAME }}-${{ env.STAGING_SLOT_NAME }}.azurewebsites.net"
          echo "Testing staging URL: $STAGING_URL"
          
          # Health endpoint check
          response=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "Health check failed with status: $response"
            exit 1
          fi
          echo "Health check passed"

      - name: Test critical endpoints
        run: |
          STAGING_URL="https://${{ env.AZURE_WEBAPP_NAME }}-${{ env.STAGING_SLOT_NAME }}.azurewebsites.net"
          
          # Test API endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL/api/test || echo "000")
          if [ "$response" != "200" ]; then
            echo "API test failed with status: $response"
            exit 1
          fi
          echo "API endpoint test passed"

      - name: Run integration tests against staging
        run: |
          echo "Running integration tests..."
          # Add your integration test commands here
          # dotnet test ./tests/Integration.Tests --environment Staging

  swap-slots:
    name: Swap Staging to Production
    runs-on: ubuntu-latest
    needs: smoke-tests
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net
    
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Swap staging slot to production
        run: |
          az webapp deployment slot swap \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --slot ${{ env.STAGING_SLOT_NAME }} \
            --target-slot production

      - name: Output production URL
        run: |
          echo "Application is now live at: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"

  post-swap-validation:
    name: Validate Production After Swap
    runs-on: ubuntu-latest
    needs: swap-slots
    
    steps:
      - name: Wait for production to stabilize
        run: sleep 20

      - name: Health check on production
        id: health-check
        run: |
          PROD_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "Testing production URL: $PROD_URL"
          
          response=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "Production health check failed with status: $response"
            echo "health_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "Production health check passed"
          echo "health_status=passed" >> $GITHUB_OUTPUT

      - name: Check Application Insights metrics
        if: always()
        run: |
          echo "Checking Application Insights for errors..."
          # Add Azure CLI commands to query App Insights
          # az monitor app-insights metrics show --app <app-insights-name> --metric requests/failed

      - name: Validate response times
        run: |
          PROD_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          
          # Check response time
          response_time=$(curl -o /dev/null -s -w '%{time_total}' $PROD_URL/health)
          echo "Response time: ${response_time}s"
          
          # Fail if response time > 2 seconds
          if (( $(echo "$response_time > 2.0" | bc -l) )); then
            echo "Response time too slow: ${response_time}s"
            exit 1
          fi

  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    needs: post-swap-validation
    if: failure()
    environment:
      name: rollback
    
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Rollback - Swap slots back
        run: |
          echo "⚠️ Post-deployment validation failed. Rolling back..."
          az webapp deployment slot swap \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --slot ${{ env.STAGING_SLOT_NAME }} \
            --target-slot production

      - name: Verify rollback
        run: |
          PROD_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          sleep 15
          
          response=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "❌ Rollback verification failed"
            exit 1
          fi
          echo "✅ Rollback successful - previous version restored"

      - name: Send rollback notification
        if: always()
        run: |
          echo "Sending rollback notification..."
          # Add notification logic (Slack, Teams, email, etc.)
          # Example: curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d '{"text":"Deployment rolled back"}'

  notify-success:
    name: Send Success Notification
    runs-on: ubuntu-latest
    needs: post-swap-validation
    if: success()
    
    steps:
      - name: Send success notification
        run: |
          echo "✅ Deployment completed successfully!"
          # Add notification logic
          # curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d '{"text":"Deployment successful"}'
